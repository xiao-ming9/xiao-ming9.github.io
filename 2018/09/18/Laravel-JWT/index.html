<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>Laravel-JWT</title><meta name="description" content="Wechat:934933088"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q || []).push(arguments)},i[r].l=1 * new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-M2RT7SDT3L', 'auto');
ga('send', 'pageview');</script><!-- End Google Analytics -->
<!-- Baidu Analytics --><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?" + '54ebb03ad7ad5b762ac8ff7958df6d3f';
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();</script><!-- End Baidu Analytics --><link rel="icon" href="https://qiniu.xiaoming.net.cn/%E5%8D%9A%E5%AE%A2icon.jpeg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">silverming's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Laravel-JWT</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#JWT简介"><span class="toc-text">JWT简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#载荷"><span class="toc-text">载荷</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#头部"><span class="toc-text">头部</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#签名"><span class="toc-text">签名</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Laravel使用JWT"><span class="toc-text">Laravel使用JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用composer安装"><span class="toc-text">使用composer安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模型使用"><span class="toc-text">模型使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置文件修改"><span class="toc-text">配置文件修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注册两个Facade"><span class="toc-text">注册两个Facade</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改auth-php"><span class="toc-text">修改auth.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注册路由"><span class="toc-text">注册路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建控制器"><span class="toc-text">创建控制器</span></a></li></ol></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/Laravel"><i class="tag post-item-tag">Laravel</i></a><a href="/tags/php"><i class="tag post-item-tag">php</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Laravel-JWT</h1><time class="has-text-grey" datetime="2018-09-18T07:39:54.000Z">2018-09-18</time><article class="mt-2 post-content"><h1 id="JWT简介"><a href="#JWT简介" class="headerlink" title="JWT简介"></a>JWT简介</h1><p>JWT(JSON Web Token)实际上是一个字符串，包括头部、载荷、签名  </p>
<h2 id="载荷"><a href="#载荷" class="headerlink" title="载荷"></a>载荷</h2><pre><code class="json">{
    &quot;sub&quot;: &quot;1&quot;,
    &quot;iss&quot;: &quot;http://localhost:8000/auth/login&quot;,
    &quot;iat&quot;: 1451888119,
    &quot;exp&quot;: 1454516119,
    &quot;nbf&quot;: 1451888119,
    &quot;jti&quot;: &quot;37c107e4609ddbcc9c096ea5ee76c667&quot;
}</code></pre>
<p>这6个字段是由JWT标准所定义的</p>
<ul>
<li>sub:该JWT所面向的对象</li>
<li>iss:该JWT的签发者</li>
<li>iat(issued at):在什么时候签发的token</li>
<li>exp(expires):token什么时候过期</li>
<li>nbf(not before):token在此时间之前不能被接收处理</li>
<li>jti:JWT ID为web token提供唯一标识  </li>
</ul>
<p>将上面的JSON对象进行base64编码后得到的字符串就是JWT的载荷</p>
<pre><code class="json">yJzdWIiOiIxIiwiaXNzIjoiaHR0cDpcL1wvbG9jYWx
ob3N0OjgwMDFcL2F1dGhcL2xvZ2luIiwiaWF0IjoxNDUxODg4MTE5LCJleHAiOjE0NTQ1MTYxMTksIm5iZiI6MTQ1MTg4OD
ExOSwianRpIjoiMzdjMTA3ZTQ2MDlkZGJjYzljMDk2ZWE1ZWU3NmM2NjcifQ</code></pre>
<a id="more"></a>
<h2 id="头部"><a href="#头部" class="headerlink" title="头部"></a>头部</h2><p>WT还需要一个头部，头部用于描述关于该JWT的最基本的信息</p>
<pre><code class="json">{
  //表明其类型和签名算法
  &quot;typ&quot;: &quot;JWT&quot;,
  &quot;alg&quot;: &quot;HS256&quot;
}</code></pre>
<p>对其进行Base64编码后就得到JWT的头部（Header）</p>
<pre><code class="json">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</code></pre>
<h2 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h2><p>将头部和荷载编码后的字符串用<code>.</code>连接在一起（<strong>头部在前</strong>）：</p>
<pre><code class="json">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwiaXNzIjoiaHR0cDpcL1wvbG9jYWx
ob3N0OjgwMDFcL2F1dGhcL2xvZ2luIiwiaWF0IjoxNDUxODg4MTE5LCJleHAiOjE0NTQ1MTYxMTksIm5iZiI6MTQ1MTg4OD
ExOSwianRpIjoiMzdjMTA3ZTQ2MDlkZGJjYzljMDk2ZWE1ZWU3NmM2NjcifQ</code></pre>
<p>将上面拼接完的字符串用HS256算法进行加密，同时提供一个密匙（secret）：</p>
<pre><code class="json">HMACSHA256(
    base64UrlEncode(header) + &quot;.&quot; +
    base64UrlEncode(payload),
    secret
)</code></pre>
<p>加密后的到的字符串称为签名：</p>
<pre><code class="json">wyoQ95RjAyQ2FF3aj8EvCSaUmeP0KUqcCJDENNfnaT4</code></pre>
<p>将这一部分拼接在被签名的字符串后面就形成了JWT</p>
<pre><code class="json">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwiaXNzIjoiaHR0cDpcL1wvbG9jYWx
ob3N0OjgwMDFcL2F1dGhcL2xvZ2luIiwiaWF0IjoxNDUxODg4MTE5LCJleHAiOjE0NTQ1MTYxMTksIm5iZiI6MTQ1MTg4OD
ExOSwianRpIjoiMzdjMTA3ZTQ2MDlkZGJjYzljMDk2ZWE1ZWU3NmM2NjcifQ.wyoQ95RjAyQ2FF3aj8EvCSaUmeP0KUqcCJDENNfnaT4</code></pre>
<h1 id="Laravel使用JWT"><a href="#Laravel使用JWT" class="headerlink" title="Laravel使用JWT"></a>Laravel使用JWT</h1><h2 id="使用composer安装"><a href="#使用composer安装" class="headerlink" title="使用composer安装"></a>使用composer安装</h2><blockquote>
<p>composer require tymon/jwt-auth 1.0.0-rc.3<br><strong>指定版本号，可以根据官网，不指定在生成配置文件时无法生成（坑）</strong></p>
</blockquote>
<p>这条命令会在config下增加一个jwt.php配置文件</p>
<blockquote>
<p>php artisan vendor:publish –provider=”Tymon\JWTAuth\Providers\LaravelServiceProvider”  </p>
</blockquote>
<p>生成加密密钥(<strong>注意在服务器端拉去代码后要执行这一句话</strong>)</p>
<blockquote>
<p>php artisan jwt:secret  </p>
</blockquote>
<p>在<code>config/jwt.php</code>中可以配置的选项：</p>
<ul>
<li>ttl：token有效期（分钟）</li>
<li>refresh_ttl：刷新token时间（分钟）</li>
<li>algo：token签名算法</li>
<li>user：指向User模型的命名空间路径</li>
<li>identifier：用于从token的sub中获取用户</li>
<li>require_claims：必须出现在token的payload中的选项，否则会抛出- TokenInvalidException异常</li>
<li>blacklist_enabled：如果该选项被设置为false，那么我们将不能废止token，即使我们刷新了token，前一个token仍然有效</li>
<li>providers：完成各种任务的具体实现，如果需要的话你可以重写他们<ul>
<li>User —— providers.user：基于sub获取用户的实现</li>
<li>JWT —— providers.jwt：加密/解密token</li>
<li>Authentication —— providers.auth：通过证书/ID获取认证用户</li>
<li>Storage —— providers.storage：存储token直到它们失效</li>
</ul>
</li>
</ul>
<h2 id="模型使用"><a href="#模型使用" class="headerlink" title="模型使用"></a>模型使用</h2><p>如果使用User表生成token，需要增加一些代码</p>
<pre><code class="php">&lt;?php
namespace App;

use Tymon\JWTAuth\Contracts\JWTSubject;
use Illuminate\Notifications\Notifiable;
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable implements JWTSubject    # 这里别忘了加
{
    use Notifiable;

    public function getJWTIdentifier()
    {
        return $this-&gt;getKey();
    }

    public function getJWTCustomClaims()
    {
        return [];
    }
}
&gt;</code></pre>
<h2 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h2><h3 id="注册两个Facade"><a href="#注册两个Facade" class="headerlink" title="注册两个Facade"></a>注册两个Facade</h3><p><strong>config/app.php</strong></p>
<pre><code class="php">&#39;aliases&#39; =&gt; [
    //添加以下两行
    &#39;JWTAuth&#39; =&gt; &#39;Tymon\JWTAuth\Facades\JWTAuth&#39;,
    &#39;JWTFactory&#39; =&gt; &#39;Tymon\JWTAuth\Facades\JWTFactory&#39;,
]</code></pre>
<p>也可以不注册使用这两个Facede，而使用<code>auth()</code>函数  </p>
<h3 id="修改auth-php"><a href="#修改auth-php" class="headerlink" title="修改auth.php"></a>修改auth.php</h3><p><strong>config/auth.php</strong></p>
<pre><code class="php">&#39;guards&#39; =&gt; [
    &#39;web&#39; =&gt; [
        &#39;driver&#39; =&gt; &#39;session&#39;,//改不改视具体情况而定
        &#39;provider&#39; =&gt; &#39;users&#39;,
    ],

    &#39;api&#39; =&gt; [
        &#39;driver&#39; =&gt; &#39;jwt&#39;,      // 原来是 token 改成 jwt
        &#39;provider&#39; =&gt; &#39;users&#39;,
    ],
],</code></pre>
<h3 id="注册路由"><a href="#注册路由" class="headerlink" title="注册路由"></a>注册路由</h3><pre><code class="php">Route::group([
    &#39;middleware&#39; =&gt; &#39;api&#39;,
    &#39;prefix&#39; =&gt; &#39;auth&#39;
],function ($router){
    Route::post(&#39;login&#39;,&#39;AuthController@login&#39;);
    Route::post(&#39;logout&#39;,&#39;AuthController@logout&#39;);
    Route::post(&#39;refresh&#39;,&#39;AuthController@refresh&#39;);
    Route::post(&#39;me&#39;,&#39;AuthController@me&#39;);
});</code></pre>
<h3 id="创建控制器"><a href="#创建控制器" class="headerlink" title="创建控制器"></a>创建控制器</h3><blockquote>
<p>php artisan make:controller AuthController  </p>
</blockquote>
<p>AuthController内容</p>
<pre><code class="php">&lt;?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;//自定义验证字段时要引入请求
use Illuminate\Support\Facades\Auth;

class AuthController extends Controller
{
    public function __construct()
    {
        $this-&gt;middleware(&#39;auth:api&#39;,[&#39;except&#39;=&gt; [&#39;login&#39;]]);
    }

    /**
     * Get a JWT via given credentials.
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function login(Request $request)
    {
        $credentials = [
            &#39;username&#39; =&gt; $request-&gt;input(&#39;username&#39;),
            &#39;password&#39; =&gt; $request-&gt;input(&#39;password&#39;)
        ];

        //标记用户登录成功
        if (! $token = auth(&#39;api&#39;)-&gt;attempt($credentials)) {
            return response()-&gt;json([&#39;error&#39; =&gt; &#39;Unauthorized&#39;], 401);
        }

        return $this-&gt;respondWithToken($token);
    }

    /**
     * Get the authenticated User.
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function me()
    {
        return response()-&gt;json(auth(&#39;api&#39;)-&gt;user());
    }

    /**
     * Log the user out (Invalidate the token).
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function logout()
    {
        auth()-&gt;logout();

        return response()-&gt;json([&#39;message&#39; =&gt; &#39;Successfully logged out&#39;]);
    }

    /**
     * Refresh a token.
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function refresh()
    {
        return $this-&gt;respondWithToken(auth(&#39;api&#39;)-&gt;refresh());
    }

    /**
     * Get the token array structure.
     *
     * @param  string $token
     *
     * @return \Illuminate\Http\JsonResponse
     */
    protected function respondWithToken($token)
    {
        return response()-&gt;json([
            &#39;access_token&#39; =&gt; $token,
            &#39;token_type&#39; =&gt; &#39;bearer&#39;,
            &#39;expires_in&#39; =&gt; auth(&#39;api&#39;)-&gt;factory()-&gt;getTTL() * 60
        ]);
    }
}</code></pre>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2018/10/01/laravel%E5%AE%9E%E7%8E%B0%E4%B8%83%E7%89%9B%E4%BA%91%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" title="laravel实现七牛云文件上传"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: laravel实现七牛云文件上传</span></a><a class="button is-default" href="/2018/09/07/laravel-admin/" title="Laravel-admin"><span class="has-text-weight-semibold">下一页: Laravel-admin</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xiao-ming9/xiao-ming9.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> silverming 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" href="https://github.com/haojen/hexo-theme-Claudia" target="_blank" rel="noopener" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span>&lt;a href=&quot;http://www.beian.miit.gov.cn/&quot;&gt;备案号&lt;/a&gt;</span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>