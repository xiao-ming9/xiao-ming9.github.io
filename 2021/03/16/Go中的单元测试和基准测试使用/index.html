

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&quot;auto&quot;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://qiniu.xiaoming.net.cn/%E5%8D%9A%E5%AE%A2icon.jpeg">
  <link rel="icon" href="https://qiniu.xiaoming.net.cn/%E5%8D%9A%E5%AE%A2icon.jpeg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="go test 工具go test 命令是一个按照一定约定和组织的测试代码的驱动程序。在包目录内，所有以 _test.go 为后缀名的源代码文件都是 go test 测试的一部分，不会被 go build 编译到最终的可执行文件中。
在 *_test.go 文件中有三种类型的函数，单元测试函数、基准测试函数和示例函数：">
  <meta name="author" content="Silverming">
  <meta name="keywords" content="">
  
  <title>Go 中的单元测试和基准测试的使用 - Silverming</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.8.9","typing":{"enable":true,"typeSpeed":70,"cursorChar":"|","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"54ebb03ad7ad5b762ac8ff7958df6d3f","google":"G-M2RT7SDT3L","gtag":"G-M2RT7SDT3L","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"tFHjJkaAYKqH8BIXKnJVurUc-MdYXbMMI","app_key":"1qR5F7XyydYd5YJtIpMJBFmP","server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Silverming</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <!-- <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i -->
              <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
           <!-- <a class="nav-link" href="javascript:" target="_blank" rel="noopener">&nbsp;<i -->
             <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://qiniu.xiaoming.net.cn/%E5%8D%9A%E5%AE%A2%E8%83%8C%E6%99%AF%E5%9B%BE.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Go 中的单元测试和基准测试的使用">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-03-16 17:16" pubdate>
        2021年3月16日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      85
       分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Go 中的单元测试和基准测试的使用</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年3月27日 中午
                
              </p>
            
            <div class="markdown-body">
              <h1 id="go-test-工具"><a href="#go-test-工具" class="headerlink" title="go test 工具"></a>go test 工具</h1><p><code>go test</code> 命令是一个按照一定约定和组织的测试代码的驱动程序。在包目录内，所有以 <code>_test.go</code> 为后缀名的源代码文件都是 <code>go test</code> 测试的一部分，不会被 <code>go build</code> 编译到最终的可执行文件中。</p>
<p>在 <code>*_test.go</code> 文件中有三种类型的函数，单元测试函数、基准测试函数和示例函数：</p>
<a id="more"></a>

<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">格式</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>测试函数</strong></td>
<td align="left">函数名前缀为Test</td>
<td align="left">测试程序的一些逻辑行为是否正确</td>
</tr>
<tr>
<td align="left"><strong>基准函数</strong></td>
<td align="left">函数名前缀为Benchmark</td>
<td align="left">测试函数的性能</td>
</tr>
<tr>
<td align="left"><strong>示例函数</strong></td>
<td align="left">函数名前缀为Example</td>
<td align="left">为文档提供示例文档</td>
</tr>
</tbody></table>
<p><code>go test</code> 命令会遍历所有的 <code>*_test.go</code> 文件中符合上述命名规则的函数，然后生成一个临时的main包用于调用相应的测试函数，然后构建并运行、报告测试结果，最后清理测试中生成的临时文件。</p>
<p>Golang 单元测试对文件名和方法名，参数都有很严格的要求。</p>
<ol>
<li>文件名必须以 <code>xx_test.go</code> 命名</li>
<li>方法必须是 <code>Test</code> 开头</li>
<li>方法参数必须 <code>t *testing.T</code></li>
<li>使用 <code>go test</code> 执行单元测试</li>
</ol>
<h2 id="go-test-的参数"><a href="#go-test-的参数" class="headerlink" title="go test 的参数"></a>go test 的参数</h2><p>go test 是 go 语言自带的测试工具，其中包含的是两类，单元测试和性能测试</p>
<p>通过 <code>go help test</code> 可以看到 go test 的使用说明：</p>
<p>格式形如： </p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">go test [-c] [-i] [build flags] [packages] [flags for test binary]<br></code></pre></div></td></tr></table></figure>

<p>参数解读：</p>
<ul>
<li><p>-c : 编译 go test 成为可执行的二进制文件，但是不运行测试。</p>
</li>
<li><p>-i : 安装测试包依赖的 package，但是不运行测试。</p>
</li>
<li><p>关于 build flags，调用 go help build，这些是编译运行过程中需要使用到的参数，一般设置为空</p>
</li>
<li><p>关于 packages，调用 go help packages，这些是关于包的管理，一般设置为空</p>
</li>
<li><p>关于 flags for test binary，调用 go help flags for test binary，这些是 go test 过程中经常使用到的参数</p>
</li>
</ul>
<p>常用示例如下：</p>
<ul>
<li>-test.v : 是否输出全部的单元测试用例（不管成功或者失败），默认没有加上，所以只输出失败的单元测试用例。</li>
<li>-test.run pattern: 只跑哪些单元测试用例</li>
<li>-test.bench patten: 只跑那些性能测试用例</li>
<li>-test.benchmem : 是否在性能测试的时候输出内存情况</li>
<li>-test.benchtime t : 性能测试运行的时间，默认是1s</li>
<li>-test.cpuprofile cpu.out : 是否输出cpu性能分析文件</li>
<li>-test.memprofile mem.out : 是否输出内存性能分析文件</li>
<li>-test.blockprofile block.out : 是否输出内部goroutine阻塞的性能分析文件</li>
<li>-test.memprofilerate n : 内存性能分析的时候有一个分配了多少的时候才打点记录的问题。这个参数就是设置打点的内存分配间隔，也就是 profile 中一个 sample 代表的内存大小。默认是设置为 512 * 1024 的。如果将它设置为 1，则每分配一个内存块就会在 profile 中有个打点，那么生成的 profile 的 sample 就会非常多。如果设置为0，那就是不做打点了。可以通过设置 <code>memprofilerate=1</code> 和 <code>GOGC=off</code> 来关闭内存回收，并且对每个内存块的分配进行观察。</li>
<li>-test.blockprofilerate n: 基本同上，控制的是 goroutine 阻塞时候打点的纳秒数。默认不设置就相当于 <code>-test.blockprofilerate=1</code>，每一纳秒都打点记录一下</li>
<li>-test.parallel n : 性能测试的程序并行 cpu 数，默认等于 GOMAXPROCS。</li>
<li>-test.timeout t : 如果测试用例运行时间超过t，则抛出 panic</li>
<li>-test.cpu 1,2,4 : 程序运行在哪些 CPU 上面，使用二进制的1所在位代表，和 nginx 的 nginx_worker_cpu_affinity 是一个道理</li>
<li>-test.short : 将那些运行时间较长的测试用例运行时间缩短</li>
</ul>
<h1 id="单元测试函数"><a href="#单元测试函数" class="headerlink" title="单元测试函数"></a>单元测试函数</h1><h2 id="单元测试函数的格式"><a href="#单元测试函数的格式" class="headerlink" title="单元测试函数的格式"></a>单元测试函数的格式</h2><p>测试函数必须导入 testing 包，基本格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestName</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-comment">//...    </span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>测试函数的名字必须以 Test 开头，可选的后缀名必须是以大写字母开头，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestAdd</span><span class="hljs-params">(t *testing.T)</span></span>&#123; ... &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSum</span><span class="hljs-params">(t *testing.T)</span></span>&#123; ... &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestLog</span><span class="hljs-params">(t *testing.T)</span></span>&#123; ... &#125;<br></code></pre></div></td></tr></table></figure>

<p>其中，参数 t 是用于报告测试失败和附加的日志信息的，<code>testing.T</code> 拥有的方法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go">Cleanup(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span>)</span><br>Error(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>Errorf(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>Fail()<br>FailNow()<br>Failed() <span class="hljs-keyword">bool</span><br>Fatal(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>Fatalf(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>Helper()<br>Log(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>Logf(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>Name() <span class="hljs-keyword">string</span><br>Skip(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>SkipNow()<br>Skipf(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)<br>Skipped() <span class="hljs-keyword">bool</span><br>TempDir() <span class="hljs-keyword">string</span><br></code></pre></div></td></tr></table></figure>

<p>其中，</p>
<ul>
<li>Fail，Error：该测试失败，该测试继续，其他测试继续执行</li>
<li>FailNow，Fatal：该测试失败，该测试终止，其他测试继续执行</li>
</ul>
<h2 id="单元测试函数的使用示例"><a href="#单元测试函数的使用示例" class="headerlink" title="单元测试函数的使用示例"></a>单元测试函数的使用示例</h2><p>在 split 包中定义一个 Split 函数，实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">"strings"</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Split</span><span class="hljs-params">(s, sep <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(result []<span class="hljs-keyword">string</span>)</span></span> &#123;<br>	i := strings.Index(s, sep)<br><br>	<span class="hljs-keyword">for</span> i &gt; <span class="hljs-number">-1</span> &#123;<br>		result = <span class="hljs-built_in">append</span>(result, s[:i])<br>		s = s[i+<span class="hljs-number">1</span>:]<br>		i = strings.Index(s, sep)<br>	&#125;<br>	result = <span class="hljs-built_in">append</span>(result, s)<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>在新建一个文件命名为 <code>split_test</code>，内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">"reflect"</span><br>	<span class="hljs-string">"testing"</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSplit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	got := Split(<span class="hljs-string">"a:b:c"</span>, <span class="hljs-string">":"</span>)      <span class="hljs-comment">// 程序输出的结果</span><br>	want := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>&#125; <span class="hljs-comment">// 期望的结果</span><br>	<span class="hljs-comment">// slice 不能直接比较，借助反射包中的方法进行比价</span><br>	<span class="hljs-keyword">if</span> !reflect.DeepEqual(want, got) &#123;<br>		t.Errorf(<span class="hljs-string">"excepted:%v, got %v"</span>, want, got)<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>在 split 目录下运行 go test 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">split » go test<br>PASS<br>ok      algorithm/split 0.005s<br></code></pre></div></td></tr></table></figure>

<p>再写一个多个字符切割字符串的测试用例：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMoreSplit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	got := Split(<span class="hljs-string">"abcd"</span>,<span class="hljs-string">"bc"</span>) <span class="hljs-comment">// 按照当前 split 的实现，这里 got 应该是[a,cd]</span><br>	want := []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>,<span class="hljs-string">"d"</span>&#125;<br>	<span class="hljs-keyword">if</span> !reflect.DeepEqual(want, got) &#123;<br>		t.Errorf(<span class="hljs-string">"excepted:%v, got %v"</span>, want, got)<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>再次运行 go test，结果如下：</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">--- FAIL: TestMoreSplit (<span class="hljs-number">0.00</span>s)<br>    split_test.go:<span class="hljs-number">21</span>: excepted:[a d], got [a cd]<br>FAIL<br><span class="hljs-keyword">exit</span> status <span class="hljs-number">1</span><br>FAIL    algorithm<span class="hljs-regexp">/split 0.005s</span><br></code></pre></div></td></tr></table></figure>

<p>可以看到测试不通过，这里可以通过添加 <code>-v</code> 参数，查看测试函数的名称和运行时间：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc"><span class="hljs-comment">// go test -v</span><br><br><span class="hljs-section">=== RUN   TestSplit</span><br><span class="hljs-bullet">--- </span>PASS: TestSplit (0.00s)<br><span class="hljs-section">=== RUN   TestMoreSplit</span><br><span class="hljs-code">    split_test.go:21: excepted:[a d], got [a cd]</span><br><span class="hljs-bullet">--- </span>FAIL: TestMoreSplit (0.00s)<br>FAIL<br>exit status 1<br>FAIL    algorithm/split 0.005s<br></code></pre></div></td></tr></table></figure>

<p>这样就可以看出哪个函数通过而哪个函数没有通过。</p>
<p>还可以在 go test 命中后添加 -run 参数，它对应一个正则表达式，只有函数名匹配上的测试函数才会被 go test 命令执行。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc">~ » go test -v -run="More"<br><span class="hljs-section">=== RUN   TestMoreSplit</span><br><span class="hljs-code">    split_test.go:21: excepted:[a d], got [a cd]</span><br><span class="hljs-bullet">--- </span>FAIL: TestMoreSplit (0.00s)<br>FAIL<br>exit status 1<br>FAIL    algorithm/split 0.006s<br></code></pre></div></td></tr></table></figure>

<p>对于上面代码的 bug 进行修复：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">"strings"</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Split</span><span class="hljs-params">(s, sep <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(result []<span class="hljs-keyword">string</span>)</span></span> &#123;<br>	i := strings.Index(s, sep)<br><br>	<span class="hljs-keyword">for</span> i &gt; <span class="hljs-number">-1</span> &#123;<br>		result = <span class="hljs-built_in">append</span>(result, s[:i])<br>		s = s[i+<span class="hljs-built_in">len</span>(sep):] <span class="hljs-comment">// 这里使用 len(sep) 获取 sep 的长度</span><br>		i = strings.Index(s, sep)<br>	&#125;<br>	result = <span class="hljs-built_in">append</span>(result, s)<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>然后重新进行测试，需要注意，<strong>修改了代码之后不要仅仅执行那些失败的测试函数，还应该完整的运行所有的测试，保证不会因为修改代码而引入了新的问题</strong>。</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go">=== RUN   TestSplit<br>--- PASS: TestSplit (<span class="hljs-number">0.00</span>s)<br>=== RUN   TestMoreSplit<br>--- PASS: TestMoreSplit (<span class="hljs-number">0.00</span>s)<br>PASS<br>ok      algorithm/split <span class="hljs-number">0.005</span>s<br></code></pre></div></td></tr></table></figure>

<h2 id="测试组"><a href="#测试组" class="headerlink" title="测试组"></a>测试组</h2><p>接下来在测试一下 split 函数对于中文字符串的支持，这个时候一种方式是再编写一个 TestChineseSplit 测试函数，更好的方式是使用如下的方法来添加更多的测试用例：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">"reflect"</span><br>	<span class="hljs-string">"testing"</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSplit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-comment">// 定义一个测试用例类型</span><br>	<span class="hljs-keyword">type</span> test <span class="hljs-keyword">struct</span> &#123;<br>		input <span class="hljs-keyword">string</span><br>		sep   <span class="hljs-keyword">string</span><br>		want  []<span class="hljs-keyword">string</span><br>	&#125;<br>	<span class="hljs-comment">// 定义一个存储测试用例的切片</span><br>	tests := []test&#123;<br>		&#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">":"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>&#125;&#125;,<br>		&#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">","</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a:b:c"</span>&#125;&#125;,<br>		&#123;input: <span class="hljs-string">"abcd"</span>, sep: <span class="hljs-string">"bc"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"d"</span>&#125;&#125;,<br>		&#123;input: <span class="hljs-string">"枯藤老树昏鸦"</span>, sep: <span class="hljs-string">"老"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"枯藤"</span>, <span class="hljs-string">"树昏鸦"</span>&#125;&#125;,<br>	&#125;<br>	<span class="hljs-comment">// 遍历切片，逐一执行测试用例</span><br>	<span class="hljs-keyword">for</span> _, tc := <span class="hljs-keyword">range</span> tests &#123;<br>		got := Split(tc.input, tc.sep)<br>		<span class="hljs-keyword">if</span> !reflect.DeepEqual(got, tc.want) &#123;<br>			<span class="hljs-comment">// 使用 %#v 格式化的方式</span><br>			t.Errorf(<span class="hljs-string">"excepted:%#v, got:%#v"</span>, tc.want, got)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="自测试-t-Run"><a href="#自测试-t-Run" class="headerlink" title="自测试 t.Run"></a>自测试 t.Run</h2><p>对于上面的测试，如果测试用例比较多的时候，是没办法一眼看出来具体是哪个测试用例失败了。可以通过如下的解决方法：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">"fmt"</span><br>	<span class="hljs-string">"reflect"</span><br>	<span class="hljs-string">"testing"</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSplit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-comment">// 定义一个测试用例类型</span><br>	<span class="hljs-keyword">type</span> test <span class="hljs-keyword">struct</span> &#123;<br>		input <span class="hljs-keyword">string</span><br>		sep   <span class="hljs-keyword">string</span><br>		want  []<span class="hljs-keyword">string</span><br>	&#125;<br>	<span class="hljs-comment">// 通过 map 存储测试用例</span><br>	tests := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]test&#123;<br>		<span class="hljs-string">"simple"</span>:      &#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">":"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>&#125;&#125;,<br>		<span class="hljs-string">"wrong sep"</span>:   &#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">","</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a:b:c"</span>&#125;&#125;,<br>		<span class="hljs-string">"more sep"</span>:    &#123;input: <span class="hljs-string">"abcd"</span>, sep: <span class="hljs-string">"bc"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"d"</span>&#125;&#125;,<br>		<span class="hljs-string">"leading sep"</span>: &#123;input: <span class="hljs-string">"枯藤老树昏鸦"</span>, sep: <span class="hljs-string">"老"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"枯藤"</span>, <span class="hljs-string">"树昏鸦"</span>&#125;&#125;,<br>	&#125;<br>	<span class="hljs-comment">// 遍历切片，逐一执行测试用例</span><br>	<span class="hljs-keyword">for</span> name, tc := <span class="hljs-keyword">range</span> tests &#123;<br>		got := Split(tc.input, tc.sep)<br>		<span class="hljs-keyword">if</span> !reflect.DeepEqual(got, tc.want) &#123;<br>			<span class="hljs-comment">// 使用 %#v 格式化的方式</span><br>			t.Errorf(<span class="hljs-string">"name:%s excepted:%#v, got:%#v"</span>, name, tc.want, got)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>另外，go1.7+ 中新增了子测试，可以按照如下方式使用 t.Run 执行子测试：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">"reflect"</span><br>	<span class="hljs-string">"testing"</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSplit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-comment">// 定义一个测试用例类型</span><br>	<span class="hljs-keyword">type</span> test <span class="hljs-keyword">struct</span> &#123;<br>		input <span class="hljs-keyword">string</span><br>		sep   <span class="hljs-keyword">string</span><br>		want  []<span class="hljs-keyword">string</span><br>	&#125;<br>	<span class="hljs-comment">// 通过 map 存储测试用例</span><br>	tests := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]test&#123;<br>		<span class="hljs-string">"simple"</span>:      &#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">":"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>&#125;&#125;,<br>		<span class="hljs-string">"wrong sep"</span>:   &#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">","</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a:b:c"</span>&#125;&#125;,<br>		<span class="hljs-string">"more sep"</span>:    &#123;input: <span class="hljs-string">"abcd"</span>, sep: <span class="hljs-string">"bc"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"d"</span>&#125;&#125;,<br>		<span class="hljs-string">"leading sep"</span>: &#123;input: <span class="hljs-string">"枯藤老树昏鸦"</span>, sep: <span class="hljs-string">"老"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"枯藤"</span>, <span class="hljs-string">"树昏鸦"</span>&#125;&#125;,<br>	&#125;<br>	<span class="hljs-comment">// 遍历切片，逐一执行测试用例</span><br>	<span class="hljs-keyword">for</span> name, tc := <span class="hljs-keyword">range</span> tests &#123;<br>		t.Run(name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>			<span class="hljs-comment">// 使用 t.Run() 执行子测试</span><br>			got := Split(tc.input, tc.sep)<br>			<span class="hljs-keyword">if</span> !reflect.DeepEqual(got, tc.want) &#123;<br>				<span class="hljs-comment">// 使用 %#v 格式化的方式</span><br>				t.Errorf(<span class="hljs-string">"name:%s excepted:%#v, got:%#v"</span>, name, tc.want, got)<br>			&#125;<br>		&#125;)<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>运行 go test -v 命令就可以看到清晰的输出内容了：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc"><span class="hljs-section">=== RUN   TestSplit</span><br><span class="hljs-section">=== RUN   TestSplit/simple</span><br><span class="hljs-section">=== RUN   TestSplit/wrong_sep</span><br><span class="hljs-section">=== RUN   TestSplit/more_sep</span><br><span class="hljs-section">=== RUN   TestSplit/leading_sep</span><br><span class="hljs-bullet">--- </span>PASS: TestSplit (0.00s)<br><span class="hljs-code">    --- PASS: TestSplit/simple (0.00s)</span><br><span class="hljs-code">    --- PASS: TestSplit/wrong_sep (0.00s)</span><br><span class="hljs-code">    --- PASS: TestSplit/more_sep (0.00s)</span><br><span class="hljs-code">    --- PASS: TestSplit/leading_sep (0.00s)</span><br>PASS<br>ok      algorithm/split 0.005s<br></code></pre></div></td></tr></table></figure>

<p>可以通过 <code>-run=RegExp</code> 来指定运行的测试用例，还可以通过 / 来指定要运行的子测试用例，<strong>例如：<code>go test -v -run=Split/simple</code> 只会运行 simple 对应的子测试用例</strong>。</p>
<h2 id="测试覆盖率-go-test-cover"><a href="#测试覆盖率-go-test-cover" class="headerlink" title="测试覆盖率 go test -cover"></a>测试覆盖率 go test -cover</h2><p><strong>测试覆盖率是代码被测试套件覆盖的百分比。</strong>通常使用的都是语句的覆盖率，也就是在测试中至少被运行一次的代码占总代码的比例。</p>
<p>GO 提供内置功能来检查代码覆盖率。可以使用 <code>go test -cover</code> 来查看测试覆盖率。例如:</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-cover</span> <br><br><span class="hljs-string">PASS</span><br><span class="hljs-attr">coverage:</span> <span class="hljs-number">100.0</span><span class="hljs-string">%</span> <span class="hljs-string">of</span> <span class="hljs-string">statements</span><br><span class="hljs-string">ok</span>      <span class="hljs-string">algorithm/split</span> <span class="hljs-number">0.</span><span class="hljs-string">005s</span><br></code></pre></div></td></tr></table></figure>

<p>可以看到测试用例的代码覆盖率是 100%。</p>
<p>Go 还提供了额外的 <code>-coverprofile</code> 参数，用来将覆盖率相关的记录信息输出到一个文件：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">go test -cover -coverprofile=c.<span class="hljs-keyword">out</span><br><br>PASS<br>coverage: <span class="hljs-number">100.0</span>% of statements<br>ok      algorithm/split <span class="hljs-number">0.005</span>s<br></code></pre></div></td></tr></table></figure>

<p>上面的命令会将覆盖率相关的信息输出到当前文件夹下面的 c.out 文件中，然后执行 <code>go tool cover -html=c.out</code>，使用 cover 工具来处理生成的记录信息，该命令会打开本地的浏览器窗口生成一个 HTML 报告:</p>
<p><img src="https://qiniu.xiaoming.net.cn/go-cover%20%E6%8A%A5%E5%91%8A.jpg" alt="go cover 报告"></p>
<h1 id="基准测试函数"><a href="#基准测试函数" class="headerlink" title="基准测试函数"></a>基准测试函数</h1><p>基准测试就是在一定的工作负载下检测程序性能的一种方法。基准测试的基本格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkName</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>    <span class="hljs-comment">// 与性能测试无关的代码</span><br>    <br>    b.ResetTimer()<br>    <span class="hljs-keyword">for</span> i:=<span class="hljs-number">0</span>;i&lt;b.N;i++ &#123;<br>        <span class="hljs-comment">// 测试代码</span><br>    &#125;<br>    b.StopTimer()<br>    <br>    <span class="hljs-comment">// 与性能测试无关的代码</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>基准测试以 Benchmark 为前缀，需要一个 <code>*testing.B</code> 类型的参数b，<strong>基准测试必须要执行 b.N 次，这样的测试才有对照性</strong>，b.N 的值是系统根据实际情况去调整的，从而保证测试的稳定性。 testing.B 拥有的方法如下：</p>
<figure class="highlight Go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs Go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Error</span><span class="hljs-params">(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Errorf</span><span class="hljs-params">(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Fail</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">FailNow</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Failed</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Fatal</span><span class="hljs-params">(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Fatalf</span><span class="hljs-params">(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Log</span><span class="hljs-params">(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Logf</span><span class="hljs-params">(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Name</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">ReportAllocs</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">ResetTimer</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">Run</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, f <span class="hljs-keyword">func</span>(b *B)</span>) <span class="hljs-title">bool</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">RunParallel</span><span class="hljs-params">(body <span class="hljs-keyword">func</span>(*PB)</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">SetBytes</span><span class="hljs-params">(n <span class="hljs-keyword">int64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">SetParallelism</span><span class="hljs-params">(p <span class="hljs-keyword">int</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Skip</span><span class="hljs-params">(args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">SkipNow</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Skipf</span><span class="hljs-params">(format <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *B)</span> <span class="hljs-title">Skipped</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">StartTimer</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">StopTimer</span><span class="hljs-params">()</span></span><br></code></pre></div></td></tr></table></figure>

<h2 id="基准测试示例"><a href="#基准测试示例" class="headerlink" title="基准测试示例"></a>基准测试示例</h2><p>为 split 包中的 Split 函数编写基准测试如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkSplit</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br>		Split(<span class="hljs-string">"枯藤老树昏鸦"</span>,<span class="hljs-string">"老"</span>)<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>基准测试并不会默认执行，需要增加 <code>-bench</code> 参数，通过执行 <code>go test -bench=Split</code> 命令执行基准测试，输出结果如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-bench=Split</span><br> <br><span class="hljs-attr">goos:</span> <span class="hljs-string">darwin</span><br><span class="hljs-attr">goarch:</span> <span class="hljs-string">amd64</span><br><span class="hljs-attr">pkg:</span> <span class="hljs-string">algorithm/split</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">Intel(R)</span> <span class="hljs-string">Core(TM)</span> <span class="hljs-string">i5-7360U</span> <span class="hljs-string">CPU</span> <span class="hljs-string">@</span> <span class="hljs-number">2.</span><span class="hljs-string">30GHz</span><br><span class="hljs-string">BenchmarkSplit-4</span>         <span class="hljs-number">9540991</span>               <span class="hljs-number">121.5</span> <span class="hljs-string">ns/op</span><br><span class="hljs-string">PASS</span><br><span class="hljs-string">ok</span>      <span class="hljs-string">algorithm/split</span> <span class="hljs-number">1.</span><span class="hljs-string">294s</span><br></code></pre></div></td></tr></table></figure>

<ul>
<li>其中 BenchmarkSplit-4 表示对 Split 函数进行基准测试，数字 4 表示 GOMAXPROCS 的值，这个对于并发基准测试很重要。</li>
<li>9540991 和 121.5 ns/op 表示每次调用 Split 函数耗时 121.5ns，这个结果是 9540991 次调用的平均值。</li>
</ul>
<p>还可以添加 <code>-benchmem</code> 参数，来获得内存分配的统计数据：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-bench=Split</span> <span class="hljs-string">-benchmem</span><br><br><span class="hljs-attr">goos:</span> <span class="hljs-string">darwin</span><br><span class="hljs-attr">goarch:</span> <span class="hljs-string">amd64</span><br><span class="hljs-attr">pkg:</span> <span class="hljs-string">algorithm/split</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">Intel(R)</span> <span class="hljs-string">Core(TM)</span> <span class="hljs-string">i5-7360U</span> <span class="hljs-string">CPU</span> <span class="hljs-string">@</span> <span class="hljs-number">2.</span><span class="hljs-string">30GHz</span><br><span class="hljs-string">BenchmarkSplit-4</span>         <span class="hljs-number">9606978</span>               <span class="hljs-number">121.7</span> <span class="hljs-string">ns/op</span>            <span class="hljs-number">48</span> <span class="hljs-string">B/op</span>          <span class="hljs-number">2</span> <span class="hljs-string">allocs/op</span><br><span class="hljs-string">PASS</span><br><span class="hljs-string">ok</span>      <span class="hljs-string">algorithm/split</span> <span class="hljs-number">1.</span><span class="hljs-string">303s</span><br></code></pre></div></td></tr></table></figure>

<p>其中，<strong>48 B/op表示每次操作内存分配了 48 字节，2 allocs/op则表示每次操作进行了 2 次内存分配</strong>。</p>
<p>对 Split 函数进行优化：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Split</span><span class="hljs-params">(s, sep <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(result []<span class="hljs-keyword">string</span>)</span></span> &#123;<br>	<span class="hljs-comment">// 提前使用 make 为 result 分配一个容量足够大的切片</span><br>	result = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">string</span>,<span class="hljs-number">0</span>,strings.Count(s,sep) +<span class="hljs-number">1</span>)<br>	i := strings.Index(s, sep)<br><br>	<span class="hljs-keyword">for</span> i &gt; <span class="hljs-number">-1</span> &#123;<br>		result = <span class="hljs-built_in">append</span>(result, s[:i])<br>		s = s[i+<span class="hljs-built_in">len</span>(sep):] <span class="hljs-comment">// 这里使用 len(sep) 获取 sep 的长度</span><br>		i = strings.Index(s, sep)<br>	&#125;<br>	result = <span class="hljs-built_in">append</span>(result, s)<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>再次运行测试：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-bench=Split</span> <span class="hljs-string">-benchmem</span><br><br><span class="hljs-attr">goos:</span> <span class="hljs-string">darwin</span><br><span class="hljs-attr">goarch:</span> <span class="hljs-string">amd64</span><br><span class="hljs-attr">pkg:</span> <span class="hljs-string">algorithm/split</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">Intel(R)</span> <span class="hljs-string">Core(TM)</span> <span class="hljs-string">i5-7360U</span> <span class="hljs-string">CPU</span> <span class="hljs-string">@</span> <span class="hljs-number">2.</span><span class="hljs-string">30GHz</span><br><span class="hljs-string">BenchmarkSplit-4</span>        <span class="hljs-number">10998399</span>                <span class="hljs-number">95.64</span> <span class="hljs-string">ns/op</span>           <span class="hljs-number">32</span> <span class="hljs-string">B/op</span>          <span class="hljs-number">1</span> <span class="hljs-string">allocs/op</span><br><span class="hljs-string">PASS</span><br><span class="hljs-string">ok</span>      <span class="hljs-string">algorithm/split</span> <span class="hljs-number">1.</span><span class="hljs-string">170s</span><br></code></pre></div></td></tr></table></figure>

<p>可以看到每次分配的内存将为 32 字节，而且只进行了 1 次内存分配。</p>
<h2 id="性能比较函数"><a href="#性能比较函数" class="headerlink" title="性能比较函数"></a>性能比较函数</h2><p>上面的基准测试只能得到给定操作的绝对耗时，但是在很多性能问题是：</p>
<ol>
<li>发生在两个不同操作之间的相对耗时，比如同一个函数处理 1000 个元素的耗时与处理 1 万甚至 100 万个元素的耗时的差别是多少？</li>
<li>再或者对于同一个任务究竟使用哪种算法性能最佳？通常需要对两个不同算法的实现使用相同的输入来进行基准比较测试。</li>
</ol>
<p>性能比较函数通常是一个带有参数的函数，被多个不同的 Benchmark 函数传入不同的值来调用。举个例子如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">benchmark</span><span class="hljs-params">(b *testing.B, size <span class="hljs-keyword">int</span>)</span></span>&#123;<span class="hljs-comment">/* ... */</span>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Benchmark10</span><span class="hljs-params">(b *testing.B)</span></span>&#123; benchmark(b, <span class="hljs-number">10</span>) &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Benchmark100</span><span class="hljs-params">(b *testing.B)</span></span>&#123; benchmark(b, <span class="hljs-number">100</span>) &#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Benchmark1000</span><span class="hljs-params">(b *testing.B)</span></span>&#123; benchmark(b, <span class="hljs-number">1000</span>) &#125;<br></code></pre></div></td></tr></table></figure>


<p>例如编写了一个计算斐波那契数列的函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> fib<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Fib</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;<br>	<span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span> &#123;<br>		<span class="hljs-keyword">return</span> n<br>	&#125;<br>	<span class="hljs-keyword">return</span> Fib(n<span class="hljs-number">-1</span>) + Fib(n<span class="hljs-number">-2</span>)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>性能测试函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> fib<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">"testing"</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">benchmarkFib</span><span class="hljs-params">(b *testing.B,n <span class="hljs-keyword">int</span>)</span></span> &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br>		Fib(n)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFib1</span><span class="hljs-params">(b *testing.B)</span></span> &#123;benchmarkFib(b,<span class="hljs-number">1</span>)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFib2</span><span class="hljs-params">(b *testing.B)</span></span> &#123;benchmarkFib(b,<span class="hljs-number">2</span>)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFib3</span><span class="hljs-params">(b *testing.B)</span></span> &#123;benchmarkFib(b,<span class="hljs-number">3</span>)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFib10</span><span class="hljs-params">(b *testing.B)</span></span> &#123;benchmarkFib(b,<span class="hljs-number">10</span>)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFib20</span><span class="hljs-params">(b *testing.B)</span></span> &#123;benchmarkFib(b,<span class="hljs-number">20</span>)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFib40</span><span class="hljs-params">(b *testing.B)</span></span> &#123;benchmarkFib(b,<span class="hljs-number">40</span>)&#125;<br></code></pre></div></td></tr></table></figure>

<p>运行基准测试：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">$ go test -bench=.<br> <br>goos: darwin<br>goarch: amd64<br>pkg: algorithm/fib<br>cpu: Intel(R) Core(TM) i5<span class="hljs-number">-7360</span>U CPU @ <span class="hljs-number">2.30</span>GHz<br>BenchmarkFib1<span class="hljs-number">-4</span>         <span class="hljs-number">654152845</span>                <span class="hljs-number">1.772</span> ns/op<br>BenchmarkFib2<span class="hljs-number">-4</span>         <span class="hljs-number">227844997</span>                <span class="hljs-number">5.229</span> ns/op<br>BenchmarkFib3<span class="hljs-number">-4</span>         <span class="hljs-number">142425820</span>                <span class="hljs-number">8.411</span> ns/op<br>BenchmarkFib10<span class="hljs-number">-4</span>         <span class="hljs-number">3659920</span>               <span class="hljs-number">323.4</span> ns/op<br>BenchmarkFib20<span class="hljs-number">-4</span>           <span class="hljs-number">29044</span>             <span class="hljs-number">41357</span> ns/op<br>BenchmarkFib40<span class="hljs-number">-4</span>               <span class="hljs-number">2</span>         <span class="hljs-number">609840838</span> ns/op<br>PASS<br>ok      algorithm/fib   <span class="hljs-number">10.091</span>s<br></code></pre></div></td></tr></table></figure>

<p>这里需要注意的是，默认情况下，<strong>每个基准测试至少运行1秒</strong>。如果在 Benchmark 函数返回时没有到 1 秒，则 b.N 的值会按1,2,5,10,20,50，…增加，并且函数再次运行。</p>
<p>最终的 BenchmarkFib40 只运行了两次，每次运行的平均值只有不到一秒。像这种情况下应该可以使用 -benchtime 标志增加最小基准时间，以产生更准确的结果。例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-bench=Fib40</span> <span class="hljs-string">-benchtime=20s</span><br> <br><span class="hljs-attr">goos:</span> <span class="hljs-string">darwin</span><br><span class="hljs-attr">goarch:</span> <span class="hljs-string">amd64</span><br><span class="hljs-attr">pkg:</span> <span class="hljs-string">algorithm/fib</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">Intel(R)</span> <span class="hljs-string">Core(TM)</span> <span class="hljs-string">i5-7360U</span> <span class="hljs-string">CPU</span> <span class="hljs-string">@</span> <span class="hljs-number">2.</span><span class="hljs-string">30GHz</span><br><span class="hljs-string">BenchmarkFib40-4</span>              <span class="hljs-number">38</span>         <span class="hljs-number">614229184</span> <span class="hljs-string">ns/op</span><br><span class="hljs-string">PASS</span><br><span class="hljs-string">ok</span>      <span class="hljs-string">algorithm/fib</span>   <span class="hljs-number">23.</span><span class="hljs-string">965s</span><br></code></pre></div></td></tr></table></figure>

<p>这一次 BenchmarkFib40 运行了 38 次。</p>
<p><strong>使用性能比较函数做测试的时候，一个容易犯的错误就是把 b.N 作为输入的大小</strong>，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// 错误示范1</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFibWrong</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> n := <span class="hljs-number">0</span>; n &lt; b.N; n++ &#123;<br>        Fib(n)<br>    &#125;<br>&#125;<br> <br><span class="hljs-comment">// 错误示范2</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFibWrong2</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>    Fib(b.N)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="重置时间-ResetTimer"><a href="#重置时间-ResetTimer" class="headerlink" title="重置时间 ResetTimer()"></a>重置时间 ResetTimer()</h2><p><code>b.ResetTimer()</code> 之前的处理不会被放到执行时间里，也不会输出到报告中，所以可以在之前做一些不计划作为测试报告的操作：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkSplit</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>    time.Sleep(<span class="hljs-number">5</span> * time.Second) <span class="hljs-comment">// 假设需要做一些耗时的无关操作</span><br>    b.ResetTimer()              <span class="hljs-comment">// 重置计时器</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br>        Split(<span class="hljs-string">"枯藤老树昏鸦"</span>, <span class="hljs-string">"老"</span>)<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="并行测试-RunParallel"><a href="#并行测试-RunParallel" class="headerlink" title="并行测试 RunParallel"></a>并行测试 RunParallel</h2><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *B)</span> <span class="hljs-title">RunParallel</span><span class="hljs-params">(body <span class="hljs-keyword">func</span>(*PB)</span>)</span><br></code></pre></div></td></tr></table></figure>

<p>该函数会以并行的方式执行给定的基准测试：</p>
<ul>
<li>RunParallel 会创建出多个 goroutine，并将 b.N 分配给这些 goroutine 执行， 其中 goroutine 数量的默认值为 GOMAXPROCS</li>
<li>用户如果想要增加非CPU受限（non-CPU-bound）基准测试的并行性， 那么可以在 RunParallel 之前调用 SetParallelism 。</li>
<li>RunParallel 通常会与 -cpu 标志一同使用。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">"testing"</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkSplitParallel</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>	<span class="hljs-comment">//b.SetParallelism(1) // 设置使用的 cpu 数量</span><br>	b.RunParallel(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pb *testing.PB)</span></span> &#123;<br>		<span class="hljs-keyword">for</span> pb.Next() &#123;<br>			Split(<span class="hljs-string">"枯藤老树昏鸦"</span>, <span class="hljs-string">"老"</span>)<br>		&#125;<br>	&#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>执行测试后：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">go</span> <span class="hljs-string">test</span> <span class="hljs-string">-bench=.</span><br> <br><span class="hljs-attr">goos:</span> <span class="hljs-string">darwin</span><br><span class="hljs-attr">goarch:</span> <span class="hljs-string">amd64</span><br><span class="hljs-attr">pkg:</span> <span class="hljs-string">algorithm/split</span><br><span class="hljs-attr">cpu:</span> <span class="hljs-string">Intel(R)</span> <span class="hljs-string">Core(TM)</span> <span class="hljs-string">i5-7360U</span> <span class="hljs-string">CPU</span> <span class="hljs-string">@</span> <span class="hljs-number">2.</span><span class="hljs-string">30GHz</span><br><span class="hljs-string">BenchmarkSplitParallel-4</span>        <span class="hljs-number">21511131</span>                <span class="hljs-number">52.12</span> <span class="hljs-string">ns/op</span><br><span class="hljs-string">PASS</span><br><span class="hljs-string">ok</span>      <span class="hljs-string">algorithm/split</span> <span class="hljs-number">1.</span><span class="hljs-string">185s</span><br></code></pre></div></td></tr></table></figure>

<h2 id="结合-pprof-性能监控"><a href="#结合-pprof-性能监控" class="headerlink" title="结合 pprof 性能监控"></a>结合 pprof 性能监控</h2><figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> fib<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">"testing"</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkFib10</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br>		Fib(<span class="hljs-number">10</span>)<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight stata"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stata">go <span class="hljs-keyword">test</span> -bench=. -benchmem -cpuprofile profile.<span class="hljs-keyword">out</span><br><span class="hljs-comment">// 还可以同时查看内存</span><br>go <span class="hljs-keyword">test</span> -bench=. -benchmem -memprofile memprofile.<span class="hljs-keyword">out</span> -cpuprofile profile.<span class="hljs-keyword">out</span><br></code></pre></div></td></tr></table></figure>

<p>这会在当前目录下生成 <code>memprofile.out</code> 和 <code>profile.out</code> 文件，接下来可以用输出的文件使用 pprof：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">go tool pprof profile.<span class="hljs-keyword">out</span> <br><br>Type: cpu<br>Time: Mar <span class="hljs-number">17</span>, <span class="hljs-number">2021</span> at <span class="hljs-number">8</span>:<span class="hljs-number">22</span>pm (CST)<br>Duration: <span class="hljs-number">1.65</span>s, Total samples = <span class="hljs-number">1.32</span>s (<span class="hljs-number">80.06</span>%)<br>Entering <span class="hljs-built_in">int</span>eractive mode (type <span class="hljs-string">"help"</span> <span class="hljs-keyword">for</span> commands, <span class="hljs-string">"o"</span> <span class="hljs-keyword">for</span> options)<br>(pprof) top<br>Showing nodes accounting <span class="hljs-keyword">for</span> <span class="hljs-number">1320</span>ms, <span class="hljs-number">100</span>% of <span class="hljs-number">1320</span>ms total<br>      flat  flat%   sum%        cum   cum%<br>    <span class="hljs-number">1300</span>ms <span class="hljs-number">98.48</span>% <span class="hljs-number">98.48</span>%     <span class="hljs-number">1320</span>ms   <span class="hljs-number">100</span>%  algorithm/fib.Fib<br>      <span class="hljs-number">20</span>ms  <span class="hljs-number">1.52</span>%   <span class="hljs-number">100</span>%       <span class="hljs-number">20</span>ms  <span class="hljs-number">1.52</span>%  runtime.newstack<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%     <span class="hljs-number">1320</span>ms   <span class="hljs-number">100</span>%  algorithm/fib.BenchmarkFib10<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%     <span class="hljs-number">1320</span>ms   <span class="hljs-number">100</span>%  testing.(*B).launch<br>         <span class="hljs-number">0</span>     <span class="hljs-number">0</span>%   <span class="hljs-number">100</span>%     <span class="hljs-number">1320</span>ms   <span class="hljs-number">100</span>%  testing.(*B).runN<br>(pprof)<br></code></pre></div></td></tr></table></figure>

<p>这个是使用 cpu 文件， 也可以使用内存文件</p>
<p>然后也可以用 list 命令检查函数需要的时间:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">(pprof) list Fib<br>Total: <span class="hljs-number">1.32</span>s<br>ROUTINE ======================== algorithm/fib.BenchmarkFib10 <span class="hljs-keyword">in</span> /Users/silverming/go-project/algorithm/fib/fib_test.go<br>         <span class="hljs-number">0</span>      <span class="hljs-number">1.32</span>s (flat, cum)   <span class="hljs-number">100</span>% of Total<br>         .          .      <span class="hljs-number">2</span>:<br>         .          .      <span class="hljs-number">3</span>:<span class="hljs-keyword">import</span> <span class="hljs-string">"testing"</span><br>         .          .      <span class="hljs-number">4</span>:<br>         .          .      <span class="hljs-number">5</span>:func BenchmarkFib10(b *testing.B) &#123;<br>         .          .      <span class="hljs-number">6</span>:   <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br>         .      <span class="hljs-number">1.32</span>s      <span class="hljs-number">7</span>:           Fib(<span class="hljs-number">10</span>)<br>         .          .      <span class="hljs-number">8</span>:   &#125;<br>         .          .      <span class="hljs-number">9</span>:&#125;<br>ROUTINE ======================== algorithm/fib.Fib <span class="hljs-keyword">in</span> /Users/silverming/go-project/algorithm/fib/fib.go<br>     <span class="hljs-number">1.30</span>s      <span class="hljs-number">1.91</span>s (flat, cum) <span class="hljs-number">144.70</span>% of Total<br>         .          .      <span class="hljs-number">1</span>:package fib<br>         .          .      <span class="hljs-number">2</span>:<br>     <span class="hljs-number">260</span>ms      <span class="hljs-number">280</span>ms      <span class="hljs-number">3</span>:func Fib(n <span class="hljs-built_in">int</span>) <span class="hljs-built_in">int</span> &#123;<br>     <span class="hljs-number">150</span>ms      <span class="hljs-number">150</span>ms      <span class="hljs-number">4</span>:   <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span> &#123;<br>     <span class="hljs-number">170</span>ms      <span class="hljs-number">170</span>ms      <span class="hljs-number">5</span>:           <span class="hljs-keyword">return</span> n<br>         .          .      <span class="hljs-number">6</span>:   &#125;<br>     <span class="hljs-number">720</span>ms      <span class="hljs-number">1.31</span>s      <span class="hljs-number">7</span>:   <span class="hljs-keyword">return</span> Fib(n<span class="hljs-number">-1</span>) + Fib(n<span class="hljs-number">-2</span>)<br>         .          .      <span class="hljs-number">8</span>:&#125;<br></code></pre></div></td></tr></table></figure>

<p>还可以通过 web 命令生成图像（没有测试成功）。。。</p>
<h2 id="Setup-与-TearDown"><a href="#Setup-与-TearDown" class="headerlink" title="Setup 与 TearDown"></a>Setup 与 TearDown</h2><p>测试程序有时需要在测试之前进行额外的设置（setup）或在测试之后进行拆卸（teardown）。</p>
<h3 id="TestMain"><a href="#TestMain" class="headerlink" title="TestMain"></a>TestMain</h3><p>通过在 <code>*_test.go</code> 文件中定义 TestMain 函数，可以在测试之前进行额外的设置（setup）或在测试之后进行拆卸（teardown）操作。</p>
<p>如果测试文件包含函数 <code>func TestMain(m *testing.M)</code> ，<strong>那么生成的测试会先调用 TestMain(m)，然后再运行具体测试</strong>。</p>
<p>TestMain 运行在主 goroutine 中, 可以在调用 m.Run 前后做任何设置（setup）和拆卸（teardown）。</p>
<p><strong>退出测试的时候应该使用 m.Run 的返回值作为参数调用 os.Exit</strong>。</p>
<p>一个使用  TestMain 来设置 Setup 和 TearDown 的示例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMain</span><span class="hljs-params">(m *testing.M)</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">"write setup code here..."</span>) <span class="hljs-comment">// 测试之前的做一些设置</span><br>    <span class="hljs-comment">// 如果 TestMain 使用了 flags，这里应该加上flag.Parse()</span><br>    retCode := m.Run()                         <span class="hljs-comment">// 执行测试</span><br>    fmt.Println(<span class="hljs-string">"write teardown code here..."</span>) <span class="hljs-comment">// 测试之后做一些拆卸工作</span><br>    os.Exit(retCode)                           <span class="hljs-comment">// 退出测试</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>需要注意的是：<strong>在调用TestMain时， flag.Parse 并没有被调用。</strong>所以如果 TestMain 依赖于 command-line 标志 (包括 testing 包的标记)，则应该显示的调用 flag.Parse。</p>
<h3 id="子测试的-Setup-与-Teardown"><a href="#子测试的-Setup-与-Teardown" class="headerlink" title="子测试的 Setup 与 Teardown"></a>子测试的 Setup 与 Teardown</h3><p>有时候可能需要为每个测试集设置 Setup 与 Teardown，也有可能需要为每个子测试设置 Setup 与 Teardown。</p>
<p>下面定义两个函数工具函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-comment">// 测试集的 Setup 和 Teardown</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupTestCase</span><span class="hljs-params">(t *testing.T)</span> <span class="hljs-title">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	t.Log(<span class="hljs-string">"如有需要哦在此执行：测试之前的 setup"</span>)<br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>		t.Log(<span class="hljs-string">"如有需要在此执行：测试之后的 teardown"</span>)<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// 子测试的 Setup 和 Teardown</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setupSubTest</span><span class="hljs-params">(t *testing.T)</span> <span class="hljs-title">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	t.Log(<span class="hljs-string">"如有需要在此执行：子测试之前的 setup"</span>)<br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>		t.Log(<span class="hljs-string">"如有需要在此执行：子测试之后的 teardown"</span>)<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>使用方式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSplit</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-keyword">type</span> test <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 定义test结构体</span><br>		input <span class="hljs-keyword">string</span><br>		sep   <span class="hljs-keyword">string</span><br>		want  []<span class="hljs-keyword">string</span><br>	&#125;<br>	tests := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]test&#123; <span class="hljs-comment">// 测试用例使用map存储</span><br>		<span class="hljs-string">"simple"</span>:      &#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">":"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>&#125;&#125;,<br>		<span class="hljs-string">"wrong sep"</span>:   &#123;input: <span class="hljs-string">"a:b:c"</span>, sep: <span class="hljs-string">","</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a:b:c"</span>&#125;&#125;,<br>		<span class="hljs-string">"more sep"</span>:    &#123;input: <span class="hljs-string">"abcd"</span>, sep: <span class="hljs-string">"bc"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">"a"</span>, <span class="hljs-string">"d"</span>&#125;&#125;,<br>		<span class="hljs-string">"leading sep"</span>: &#123;input: <span class="hljs-string">"枯藤老树昏鸦"</span>, sep: <span class="hljs-string">"老"</span>, want: []<span class="hljs-keyword">string</span>&#123;<span class="hljs-string">""</span>, <span class="hljs-string">"枯藤"</span>, <span class="hljs-string">"树昏鸦"</span>&#125;&#125;,<br>	&#125;<br>	teardownTestCase := setupTestCase(t) <span class="hljs-comment">// 测试之前执行 setup 操作</span><br>	<span class="hljs-keyword">defer</span> teardownTestCase(t)            <span class="hljs-comment">// 测试之后执行 teardown 操作</span><br><br>	<span class="hljs-keyword">for</span> name, tc := <span class="hljs-keyword">range</span> tests &#123;<br>		t.Run(name, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123; <span class="hljs-comment">// 使用 t.Run() 执行子测试</span><br>			teardownSubTest := setupSubTest(t) <span class="hljs-comment">// 子测试之前执行 setup 操作</span><br>			<span class="hljs-keyword">defer</span> teardownSubTest(t)           <span class="hljs-comment">// 测试之后执行 teardown 操作</span><br>			got := Split(tc.input, tc.sep)<br>			<span class="hljs-keyword">if</span> !reflect.DeepEqual(got, tc.want) &#123;<br>				t.Errorf(<span class="hljs-string">"excepted:%#v, got:%#v"</span>, tc.want, got)<br>			&#125;<br>		&#125;)<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>测试结果如下：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs asciidoc">$ go test -v                                                                                                    silverming@ZIMINGXING-MB1<br><span class="hljs-section">=== RUN   TestSplit</span><br><span class="hljs-code">    split_test.go:10: 如有需要哦在此执行：测试之前的 setup</span><br><span class="hljs-section">=== RUN   TestSplit/more_sep</span><br><span class="hljs-code">    split_test.go:18: 如有需要在此执行：子测试之前的 setup</span><br><span class="hljs-code">    split_test.go:20: 如有需要在此执行：子测试之后的 teardown</span><br><span class="hljs-section">=== RUN   TestSplit/leading_sep</span><br><span class="hljs-code">    split_test.go:18: 如有需要在此执行：子测试之前的 setup</span><br><span class="hljs-code">    split_test.go:46: excepted:[]string&#123;"", "枯藤", "树昏鸦"&#125;, got:[]string&#123;"枯藤", "树昏鸦"&#125;</span><br><span class="hljs-code">    split_test.go:20: 如有需要在此执行：子测试之后的 teardown</span><br><span class="hljs-section">=== RUN   TestSplit/simple</span><br><span class="hljs-code">    split_test.go:18: 如有需要在此执行：子测试之前的 setup</span><br><span class="hljs-code">    split_test.go:20: 如有需要在此执行：子测试之后的 teardown</span><br><span class="hljs-section">=== RUN   TestSplit/wrong_sep</span><br><span class="hljs-code">    split_test.go:18: 如有需要在此执行：子测试之前的 setup</span><br><span class="hljs-code">    split_test.go:20: 如有需要在此执行：子测试之后的 teardown</span><br><span class="hljs-section">=== CONT  TestSplit</span><br><span class="hljs-code">    split_test.go:12: 如有需要在此执行：测试之后的 teardown</span><br><span class="hljs-bullet">--- </span>FAIL: TestSplit (0.00s)<br><span class="hljs-code">    --- PASS: TestSplit/more_sep (0.00s)</span><br><span class="hljs-code">    --- FAIL: TestSplit/leading_sep (0.00s)</span><br><span class="hljs-code">    --- PASS: TestSplit/simple (0.00s)</span><br><span class="hljs-code">    --- PASS: TestSplit/wrong_sep (0.00s)</span><br>FAIL<br>exit status 1<br>FAIL    algorithm/split 0.005s<br></code></pre></div></td></tr></table></figure>

<h1 id="示例函数-Example"><a href="#示例函数-Example" class="headerlink" title="示例函数 Example"></a>示例函数 Example</h1><h2 id="示例函数的格式"><a href="#示例函数的格式" class="headerlink" title="示例函数的格式"></a>示例函数的格式</h2><p>被 go test 特殊对待的第三种函数就是示例函数，它们的函数名以 Example 为前缀。它们既没有参数也没有返回值。标准格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ExampleName</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="示例函数示例"><a href="#示例函数示例" class="headerlink" title="示例函数示例"></a>示例函数示例</h2><p>为 Split 函数编写一个示例函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs go"><span class="hljs-keyword">package</span> split_test<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">"algorithm/split"</span><br>	<span class="hljs-string">"fmt"</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ExampleSplit</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Println(split.Split(<span class="hljs-string">"a:b:c"</span>,<span class="hljs-string">":"</span>))<br>	fmt.Println(split.Split(<span class="hljs-string">"枯藤老树昏鸦"</span>,<span class="hljs-string">"老"</span>))<br>	<span class="hljs-comment">// Output</span><br>	<span class="hljs-comment">// [a b c]</span><br>	<span class="hljs-comment">// [枯藤 树昏鸦]</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>这个时候函数就会生成相应的文档：</p>
<p><img src="https://qiniu.xiaoming.net.cn/%E7%A4%BA%E4%BE%8B%E5%87%BD%E6%95%B0%E6%96%87%E6%A1%A3%E7%A4%BA%E4%BE%8B.png" alt="示例函数文档示例"></p>
<p>为代码编写示例代码有如下三个用处：</p>
<ol>
<li><p>示例函数能够作为文档直接使用，例如基于 web 的 godoc 中能把示例函数与对应的函数或包相关联。</p>
</li>
<li><p>示例函数只要包含了 <code>// Output:</code> 也是可以通过 go test 运行的可执行测试。</p>
<div class="hljs code-wrapper"><pre><code>split $ go test -run Example
PASS
ok      github.com/pprof/studygo/code_demo/test_demo/split       0.006s</code></pre></div></li>
</ol>
<ol start="3">
<li>示例函数提供了可以直接运行的示例代码，可以直接在 golang.org 的 godoc 文档服务器上使用 Go Playground 运行示例代码。</li>
</ol>
<p><strong>参考文章：</strong></p>
<blockquote>
<p><a href="https://blog.csdn.net/fly910905/article/details/105905491" target="_blank" rel="noopener">Go基础：如何做单元测试和基准测试</a></p>
</blockquote>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/go/">go</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/03/23/go%E4%B8%AD%E7%9A%84time%E5%8C%85/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">go 中 time 包的使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/03/16/go%E4%B8%ADContext%E5%8C%85/">
                        <span class="hidden-mobile">Go 中 Context 包</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                  
                
                
  <script type="text/javascript">
    Fluid.utils.lazyComments('comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'xiao-ming9/xiao-ming9.github.io');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        粤ICP备18114217号
      </a>
    </span>
    
      
        <span>
          <a
            href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=粤ICP备18114217号-1"
            rel="nofollow noopener"
            class="beian-police"
            target="_blank"
          >
            
              <span style="visibility: hidden; width: 0">|</span>
              <img src="/img/police_beian.png" alt="police-icon"/>
            
            <span>粤ICP备18114217号-1</span>
          </a>
        </span>
      
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->




  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?54ebb03ad7ad5b762ac8ff7958df6d3f";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'G-M2RT7SDT3L', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  
    <!-- Google gtag.js -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M2RT7SDT3L"></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-M2RT7SDT3L');
    </script>
  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
