<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>Nginx架构</title><meta name="description" content="Wechat:934933088"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q || []).push(arguments)},i[r].l=1 * new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-M2RT7SDT3L', 'auto');
ga('send', 'pageview');</script><!-- End Google Analytics -->
<!-- Baidu Analytics --><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?" + '54ebb03ad7ad5b762ac8ff7958df6d3f';
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();</script><!-- End Baidu Analytics --><link rel="icon" href="https://qiniu.xiaoming.net.cn/%E5%8D%9A%E5%AE%A2icon.jpeg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">silverming's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Nginx架构</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx常见问题"><span class="toc-text">Nginx常见问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实际访问路径为-local-path-image-request-path-image-cat-png"><span class="toc-text">实际访问路径为/local_path/image/request_path/image/cat.png</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实际访问路径为-local-path-image-cat-png"><span class="toc-text">实际访问路径为/local_path/image/cat.png</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU亲和"><span class="toc-text">CPU亲和</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx安全"><span class="toc-text">Nginx安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#常见恶意行为"><span class="toc-text">常见恶意行为</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见攻击手段"><span class="toc-text">常见攻击手段</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/nginx"><i class="tag post-item-tag">nginx</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Nginx架构</h1><time class="has-text-grey" datetime="2019-07-23T23:59:56.000Z">2019-07-24</time><article class="mt-2 post-content"><h1 id="Nginx常见问题"><a href="#Nginx常见问题" class="headerlink" title="Nginx常见问题"></a>Nginx常见问题</h1><ol>
<li>多个server配置了相同的server_name优先级访问：<br>优先使用最先读取到的配置</li>
<li>location匹配优先级：<br>由高到低分别是：</li>
</ol>
<ul>
<li><code>=</code>进行普通字符精确匹配，即完全匹配</li>
<li><code>^~</code>表示普通字符匹配，使用前缀匹配，表示以什么开头</li>
<li><code>~</code>开头表示区分大小写的正则匹配</li>
<li><code>~*</code> 开头表示不区分大小写的正则匹配</li>
<li><code>/</code>通用匹配，任何请求都会匹配到</li>
</ul>
<ol start="3">
<li>try_files的使用<br>用于按顺序检查文件是否存在<pre><code class="nginx">location / {
     # 首先查找$rui路径是否存在，不存在则查找$uri/路径，如果也不存在则跳转到/index.php目录
     try_files $uri $uri/ /index.php
}</code></pre>
</li>
<li>alias和root的区别<pre><code class="nginx"># 当访问路径为http://www.test.com/request_path/image/cat.png
</code></pre>
</li>
</ol>
<h1 id="实际访问路径为-local-path-image-request-path-image-cat-png"><a href="#实际访问路径为-local-path-image-request-path-image-cat-png" class="headerlink" title="实际访问路径为/local_path/image/request_path/image/cat.png"></a>实际访问路径为/local_path/image/request_path/image/cat.png</h1><p>location /request_path/image/ {<br>        root /local_path/image/;<br>}</p>
<h1 id="实际访问路径为-local-path-image-cat-png"><a href="#实际访问路径为-local-path-image-cat-png" class="headerlink" title="实际访问路径为/local_path/image/cat.png"></a>实际访问路径为/local_path/image/cat.png</h1><p>location /request_path/image/ {<br>        alias /local_path/image/;<br>}</p>
<pre><code>5. 获取用户真实ip地址
对第一层代理设置头信息存储ip，这样后端服务就可以通过$x_real_ip获得真实ip
&gt; set x_real_ip = $remote_addr  

6. 常见错误码
- 413 Request Entity Too Large
**解决方法**： 用户上传文件限制 `client_max_body_size`
- 502 bad geteway：后端服务无响应
- 504 Geteway Time-out：后端服务执行超时

# 性能优化
接口压力测试工具：`ab`
1. 需要先安装`http-tools`
2. 使用：
&gt; ab -n 2000 -c 2 http://127.0..0.1/  

- n 总的请求数
- c 并发数
- k 是否开启长连接

## 设置Nginx文件句柄
```nginx
# 指定一个nginx进程可以打开的最多文件描述符数目
worker_rlimit_nofile num;</code></pre><h2 id="CPU亲和"><a href="#CPU亲和" class="headerlink" title="CPU亲和"></a>CPU亲和</h2><p>将nginx设置与当前机器物理cpu个数相等，同时配置核心数<br>总核心数=cpu个数*每个核心数</p>
<pre><code class="nginx"># 启动多少个worker进程，建议与cpu总核心数一致,默认1
worker_processes num;
# cpu亲缘 ，将工作进程绑定到CPU组。
worker_cpu_affinity cpumask...;

# 设置工作进程可以打开的最大并发连接数
# 配置在events，默认512
# 这个数字包括所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接。另一个考虑因素是实际的并发连接数不能超过最大打开文件数的当前限制，可以通过 worker_rlimit_nofile更改。
worker_connections number;</code></pre>
<p><strong>worker_cpu_affinity配置方法</strong></p>
<ol>
<li><p>使用位掩码表示:绑定到cpu0，cpu1，cpu2，cpu3</p>
<blockquote>
<p>worker_cpu_affinity 0001 0010 0100 1000;  </p>
</blockquote>
</li>
<li><p>将工作进程绑定到CPU组,将第一个工作进程绑定到CPU0 / CPU2，将第二个工作进程绑定到CPU1 / CPU3。</p>
<blockquote>
<p>worker_processes 2;<br>worker_cpu_affinity 0101 1010;  </p>
</blockquote>
</li>
<li><p>使用<code>auto</code>允许将工作进程自动绑定到可用的CPU：</p>
<blockquote>
<p>worker_processes auto;<br>worker_cpu_affinity auto;  </p>
</blockquote>
</li>
</ol>
<h1 id="Nginx安全"><a href="#Nginx安全" class="headerlink" title="Nginx安全"></a>Nginx安全</h1><h2 id="常见恶意行为"><a href="#常见恶意行为" class="headerlink" title="常见恶意行为"></a>常见恶意行为</h2><p>爬虫行为和恶意抓取，资源盗用<br><strong>解决方式</strong>：</p>
<ul>
<li>使用基础防盗链功能，不让恶意用户能轻易的爬去网站对外数据</li>
<li>secure_link_module:对数据安全性提高加密验证和实效性，适合如核心重要数据</li>
<li>access_module:对后台、部分用户服务的数据提供IP防控 </li>
</ul>
<h2 id="常见攻击手段"><a href="#常见攻击手段" class="headerlink" title="常见攻击手段"></a>常见攻击手段</h2><ol>
<li>后台密码撞库：通过猜测密码字典不断对后台系统登录性尝试，获取后台登录密码</li>
</ol>
<p><strong>解决方式</strong>：</p>
<ul>
<li>后台登录密码复杂度</li>
<li>access_module:对后台提供IP防控</li>
<li>预警机制</li>
</ul>
<ol start="2">
<li>文件上传漏洞：利用这些可以上传文件的接口将恶意代码植入到服务器中，再通过url去访问以执行代码<br>例如：在Nginx早期版本：<blockquote>
<p><a href="http://www.server_name.com/upload/1.jpg/1.php" target="_blank" rel="noopener">http://www.server_name.com/upload/1.jpg/1.php</a>  </p>
</blockquote>
</li>
</ol>
<p>nginx会将其作为php代码执行<br><strong>解决方式</strong>：检查文件上传格式是否合规</p>
<pre><code class="nginx">location ^~ /upload{
        root /opt/app/images;
        if($request_filename ~* (.*)\.php){
                return 403;
        }
}</code></pre>
<ol start="3">
<li>SQL注入：利用未过滤，未审核用户输入的攻击方法，让应用运行本不应该运行的SQL代码</li>
</ol>
<p><strong>解决方式</strong><br>Nginx+LUA防火墙：拦截Cookie类型攻击，异常post请求，cc攻击(对某一个接口高频率访问），拦截URL，arg（get请求提交的参数）</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2019/07/29/GOF23/" title="GOF23"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: GOF23</span></a><a class="button is-default" href="/2019/07/23/Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB,rewrite%E8%A7%84%E5%88%99,HTTPS%E6%9C%8D%E5%8A%A1/" title="Nginx动静分离,rewrite规则,HTTPS服务"><span class="has-text-weight-semibold">下一页: Nginx动静分离,rewrite规则,HTTPS服务</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xiao-ming9/xiao-ming9.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> silverming 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" href="https://github.com/haojen/hexo-theme-Claudia" target="_blank" rel="noopener" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span>&lt;a href=&quot;http://www.beian.miit.gov.cn/&quot;&gt;备案号&lt;/a&gt;</span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>