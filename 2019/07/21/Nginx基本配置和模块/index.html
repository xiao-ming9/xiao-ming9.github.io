<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>Nginx基本配置和模块</title><meta name="description" content="Wechat:934933088"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q || []).push(arguments)},i[r].l=1 * new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'G-M2RT7SDT3L', 'auto');
ga('send', 'pageview');</script><!-- End Google Analytics -->
<!-- Baidu Analytics --><script>var _hmt = _hmt || [];
(function() {
var hm = document.createElement("script");
hm.src = "//hm.baidu.com/hm.js?" + '54ebb03ad7ad5b762ac8ff7958df6d3f';
var s = document.getElementsByTagName("script")[0];
s.parentNode.insertBefore(hm, s);
})();</script><!-- End Baidu Analytics --><link rel="icon" href="https://qiniu.xiaoming.net.cn/%E5%8D%9A%E5%AE%A2icon.jpeg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">silverming's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Nginx基本配置和模块</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx基本配置"><span class="toc-text">Nginx基本配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx日志类型"><span class="toc-text">Nginx日志类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx变量"><span class="toc-text">nginx变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置语法"><span class="toc-text">配置语法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx模块"><span class="toc-text">Nginx模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#http-stub-status-module配置"><span class="toc-text">http_stub_status_module配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-random-index-module模块"><span class="toc-text">http_random_index_module模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-sub-module模块"><span class="toc-text">http_sub_module模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx请求限制模块"><span class="toc-text">Nginx请求限制模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#指明具体使用的限制空间-可以定义在http，server，location中"><span class="toc-text">指明具体使用的限制空间,可以定义在http，server，location中</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#zone：空间名，表示使用哪一块空间"><span class="toc-text">zone：空间名，表示使用哪一块空间</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#number：同一时间允许的连接并发数"><span class="toc-text">number：同一时间允许的连接并发数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx访问控制模块"><span class="toc-text">Nginx访问控制模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#http-access-module"><span class="toc-text">http_access_module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-auth-basic-module"><span class="toc-text">http_auth_basic_module</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#comment"><span class="toc-text">comment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#secure-link-midule"><span class="toc-text">secure_link_midule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置语法-1"><span class="toc-text">配置语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置示例"><span class="toc-text">配置示例</span></a></li></ol></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/nginx"><i class="tag post-item-tag">nginx</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Nginx基本配置和模块</h1><time class="has-text-grey" datetime="2019-07-21T13:33:58.000Z">2019-07-21</time><article class="mt-2 post-content"><h1 id="Nginx基本配置"><a href="#Nginx基本配置" class="headerlink" title="Nginx基本配置"></a>Nginx基本配置</h1><pre><code class="nginx">#user  nobody;     #设置nginx服务的系统使用用户
worker_processes  1;     #工作进程数，一般跟电脑cpu保持一致

#error_log  logs/error.log;     #nginx错误日志
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info; #错误日志级别

#pid        logs/nginx.pid;     #nginx服务启动的pid


events {
    worker_connections  1024;     #每个进程允许最大连接数
    #use;    #工作进程数
}


http {
    include       mime.types;
    default_type  application/octet-stream;

      #日志语法，main表示格式名称
    #log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
    #                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
    #                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;

    #access_log  logs/access.log  main; #日志位置，与上面的main对应

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65; #连接超时时间

    #gzip  on;
    # 每个服务配置一个server
    server {
        listen       8080;     #监听端口
        server_name  localhost;    #服务器名称

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

    #路径控制（加“/”表示控制首页路径）
        location / {
            root   html;    #首页文件路径
            index  index.html index.htm;
        }

        #error_page  404              /404.html; #统一错误页面，指定错误码定位到错误路径

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;

    # 将上面指定的错误路径指定到特定的路径页面
        location = /50x.html {
            root   html;
        } 
    }
    include servers/*; #导入其他子配置文件
}</code></pre>
<a id="more"></a>
<h1 id="Nginx日志类型"><a href="#Nginx日志类型" class="headerlink" title="Nginx日志类型"></a>Nginx日志类型</h1><p>包括:<strong>error.log</strong>和<strong>access_log</strong><br>error.log:错误日志<br>access_log:每次请求的状态<br>日志的形式可以在配置文件中进行配置</p>
<h2 id="nginx变量"><a href="#nginx变量" class="headerlink" title="nginx变量"></a>nginx变量</h2><p>在配置日志格式时，可以使用以下变量进行配置；</p>
<ul>
<li>HTTP请求变量：<code>arg_PARAMETER</code>,<code>http_HEADER</code>,<code>sent_http_HEADER</code></li>
<li>内置变量：Nginx有内置的许多变量，可以上官网查看</li>
<li>自定义变量</li>
</ul>
<h2 id="配置语法"><a href="#配置语法" class="headerlink" title="配置语法"></a>配置语法</h2><p>参考上面基础配置示例，在变量前加上美元符，同时使用单引号扩起来</p>
<pre><code class="nginx">log_format main &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                 &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</code></pre>
<h1 id="Nginx模块"><a href="#Nginx模块" class="headerlink" title="Nginx模块"></a>Nginx模块</h1><h2 id="http-stub-status-module配置"><a href="#http-stub-status-module配置" class="headerlink" title="http_stub_status_module配置"></a>http_stub_status_module配置</h2><p>用于展示Nginx处理当前连接的客户端状态，默认没有配置，可以在配置文件的server,location中配置</p>
<pre><code class="nginx">location /mystatus{
        stub_status;
}</code></pre>
<p>更改完配置之后可以先测试文件是否出错：</p>
<blockquote>
<p>nginx -tc /usr/local/etc/nginx/nginx.conf  </p>
</blockquote>
<p>测试成功之后重新加载配置文件：</p>
<blockquote>
<p>nginx -s reload -c /usr/local/etc/nginx/nginx.conf  </p>
</blockquote>
<p>访问定义的<code>mystatus</code>页面：出现以下内容：</p>
<pre><code class="c">Active connections: 2 //当前活跃连接数
server accepts handled requests
 41 41 40 //握手总次数，处理连接数，总的请求数（通常握手数=连接数，表示数据无丢失）
Reading: 0 Writing: 1 Waiting: 1 （状态，正在读，正在写，等待）</code></pre>
<h2 id="http-random-index-module模块"><a href="#http-random-index-module模块" class="headerlink" title="http_random_index_module模块"></a>http_random_index_module模块</h2><p>用于从目录中选择一个作为随机主页（一般较少用到）<br>配置时在location中配置：</p>
<pre><code class="nginx">location / {
        root   某个目录; #该目录下有多个html文件随机作为主页
      #index  index.html index.htm;
      random_index on
}</code></pre>
<h2 id="http-sub-module模块"><a href="#http-sub-module模块" class="headerlink" title="http_sub_module模块"></a>http_sub_module模块</h2><p>用于HTTP中html内容替换，一般也比较少用<br>配置时同样在http,server,location中配置：</p>
<pre><code class="nginx">sub_filter &#39;要替换的内容‘ ’替换后的内容‘;
sub_filter_last_modified on|off; #用于服务端和浏览器端每一次请求时校验服务端内容是否发生变更，默认是off
sub_filter_once on|off; #替换全部还是第一个，默认on，表示只替换第一个</code></pre>
<h2 id="Nginx请求限制模块"><a href="#Nginx请求限制模块" class="headerlink" title="Nginx请求限制模块"></a>Nginx请求限制模块</h2><p>连接频率限制：<code>limit-conn-module</code><br>请求频率限制：<code>limit-req_module</code></p>
<blockquote>
<p>HTTP1.0 TCP不能复用，一次连接对应一次请求；HTTP1.1支持TCP顺序性服用，一个连接可以顺序性发起多个连接；HTTP2.0之后TCP连接可以多路复用  </p>
</blockquote>
<p>配置语法：</p>
<ul>
<li>连接限制：<pre><code class="nginx"># 首先需要申请连接限制空间,用于存储连接状态，需要定义在http中
# key：以连接哪个变量作为key，作为每次连接的标识
# name：空间名
# size：空间大小
limit_conn_zone key zone=name:size;
</code></pre>
</li>
</ul>
<h1 id="指明具体使用的限制空间-可以定义在http，server，location中"><a href="#指明具体使用的限制空间-可以定义在http，server，location中" class="headerlink" title="指明具体使用的限制空间,可以定义在http，server，location中"></a>指明具体使用的限制空间,可以定义在http，server，location中</h1><h1 id="zone：空间名，表示使用哪一块空间"><a href="#zone：空间名，表示使用哪一块空间" class="headerlink" title="zone：空间名，表示使用哪一块空间"></a>zone：空间名，表示使用哪一块空间</h1><h1 id="number：同一时间允许的连接并发数"><a href="#number：同一时间允许的连接并发数" class="headerlink" title="number：同一时间允许的连接并发数"></a>number：同一时间允许的连接并发数</h1><p>limit_conn zone number</p>
<pre><code>- 请求频率限制：
```nginx
# 同样需要先定义一个空间，同样只能在http中
# rate为限制请求的速率
limit_req_zone key zone=name:size rate=rate

# 指明具体的限制空间，可以定义在http，server,location中
# burst表死延迟处理，如果请求数超过rate，剩下的请求（注意是全部请求）将被延迟下一秒/分处理，如果请求数超过burst定义的数量，多余的请求则直接返回503错误。
# 如果开启nodelay，则处理burst数量的请求延迟，超过rate的请求直接返回503，不再延迟处理。
limit_req zone=name [burst=number] [nodelay]</code></pre><p>配置示例：</p>
<pre><code class="nginx">http{
    # 使用ip地址作为key标识每一次链接，同时加上binary该变量更节省内存空间
    limit_conn_zone $binary_remote_addr zone=conn_zone:1m
    # 1r/s表示一秒之内最多1次请求，也可以用5r/m,表示一分钟之内最多5次请求
    limit_req_zone $binary_remote_addr zone=req_zone:1m rate=1r/s;

    server{
        location / {
            limit_conn conn_zone 3;
            limit_req zone=req_zone burst=3 nodelay;
        }
    }
}</code></pre>
<h2 id="Nginx访问控制模块"><a href="#Nginx访问控制模块" class="headerlink" title="Nginx访问控制模块"></a>Nginx访问控制模块</h2><p>基于ip的访问控制：<code>http_access_module</code><br>基于用户的信任登录：<code>http_auth_basic_module</code></p>
<h3 id="http-access-module"><a href="#http-access-module" class="headerlink" title="http_access_module"></a>http_access_module</h3><p>配置语法：</p>
<pre><code class="nginx"># 配置在http，server，location，limit_except中

# 配置允许哪些访问
# 可以按照ip，网段，unix中的socket，所有配置
allow address|CIDR|unix:|all;
# 配置禁止哪些访问
deny address|CIDR|unix:|all;</code></pre>
<blockquote>
<p>allow和den可以成对配置，比如只禁止某一个ip，可以配置<code>deny ip;allow all</code>，注意先后顺序  </p>
</blockquote>
<p><strong>局限性</strong><br>使用ip访问控制，一旦客户端有中间件代理，则Nginx最终读取到的是代理的ip地址，而无法对预设的ip做限制，此时有以下几种解决方法：</p>
<ol>
<li><p><code>http_x_forwarded_for</code>，会同时记录源地址IP和代理ip：</p>
<blockquote>
<p>http_x_forwarded_for = Client IP,Proxy(1)IP,Proxy(2)IP,…  </p>
</blockquote>
</li>
<li><p>结合geo模块</p>
</li>
<li><p>听过HTTP自定义变量传递</p>
</li>
</ol>
<h3 id="http-auth-basic-module"><a href="#http-auth-basic-module" class="headerlink" title="http_auth_basic_module"></a>http_auth_basic_module</h3><p>配置语法：</p>
<pre><code class="nginx"># 配置在http，server，location，limit_except,默认是off
# string:即表示配置开启，又会在前端显示相应的字符串信息
auth_basic string|off;

# 配置在http，server，location，limit_except
# file:文件路径，作为认证存储用户名，密码等信息的文件
auth_basic_user_file file;</code></pre>
<p>对于存储用户认证信息的文件有指定的格式：</p>
<blockquote>
<h1 id="comment"><a href="#comment" class="headerlink" title="comment"></a>comment</h1><p>name1:password1<br>name2:password2:comment<br>name3:password3  </p>
</blockquote>
<p>可以使用<code>htpasswd</code>工具进行文件编辑：</p>
<pre><code>» htpasswd                                                                                    
Usage:
    htpasswd [-cimBdpsDv] [-C cost] passwordfile username
    htpasswd -b[cmBdpsDv] [-C cost] passwordfile username password

    htpasswd -n[imBdps] [-C cost] username
    htpasswd -nb[mBdps] [-C cost] username password
 -c  Create a new file.
 -n  Don&#39;t update file; display results on stdout.
 -b  Use the password from the command line rather than prompting for it.
 -i  Read password from stdin without verification (for script usage).
 -m  Force MD5 encryption of the password (default).
 -B  Force bcrypt encryption of the password (very secure).
 -C  Set the computing time used for the bcrypt algorithm
     (higher is more secure but slower, default: 5, valid: 4 to 31).
 -d  Force CRYPT encryption of the password (8 chars max, insecure).
 -s  Force SHA encryption of the password (insecure).
 -p  Do not encrypt the password (plaintext, insecure).
 -D  Delete the specified user.
 -v  Verify password for the specified user.
On other systems than Windows and NetWare the &#39;-p&#39; flag will probably not work.
The SHA algorithm does not use a salt and is less secure than the MD5 algorithm.</code></pre><p>输入下面指令然后输入两次密码即可生成文件</p>
<blockquote>
<p>htpasswd -c [文件路径] [用户名]  </p>
</blockquote>
<pre><code class="nginx">location / {
      root   html;
      auth_basic &quot;请输入用户名和密码以访问该页面。。。&quot;;
      auth_basic_user_file auth.conf;
        index  index.html index.htm;
}</code></pre>
<p><strong>局限性</strong>：</p>
<ul>
<li>用户信息依赖文件方式</li>
<li>操作管理繁琐，效率低下</li>
</ul>
<p>可以通过结合LUA实现高效验证，或者和LDAP打通<br>安全模块</p>
<h3 id="secure-link-midule"><a href="#secure-link-midule" class="headerlink" title="secure_link_midule"></a>secure_link_midule</h3><ol>
<li>制定并允许检查请求的链接的真实性以及保护资源免遭未经授权的访问</li>
<li>限制链接生效周期</li>
</ol>
<h3 id="配置语法-1"><a href="#配置语法-1" class="headerlink" title="配置语法"></a>配置语法</h3><pre><code class="nginx"># 配置在http，server，location中
secure_link expression

# 配置在http，server，location中
secure_link_md5 expression</code></pre>
<ul>
<li>对于secure_link:<br>expression由<strong>校验值</strong>和<strong>过期时间</strong>组成，其中校验值将会与 <code>secure_link_md5</code>中的指定参数的MD5哈希值进行对比，如果两个值不一致,<code>$secure_link</code>变量的值是<code>空（empty）</code>,如果两个值一致，则进行过期检查，如果<code>过期了</code>，则<code>$secure_link</code>变量值是<code>0</code>,如果没过期，则为<code>1</code> ;如果链接是有时效性的，那么过期时间用时间戳进行设置，在MD5哈希值后面声明，用逗号隔开。如果没有设置过期时间，该链接永久有效。</li>
<li>对于secure_link_md5:<br><code>expression</code>指定计算md5哈希值的参数，该md5值将会和url中传递的md5值进行对比校验。expression一般包含<code>uri</code>（如demo.com/s/link, uri则为<code>/s/link</code>）以及加密<code>密钥secret</code>，如果该链接具有时效，则expression需包含<code>$secure_link_expires</code>，expression还可以加入客户端信息，如访问IP,浏览器版本信息等</li>
</ul>
<h3 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h3><pre><code class="nginx">location / {
        # 此处会获取参数名为md5和参数名为expires的值
        secure_link $arg_md5,$arg_expires;
        # 将会根据参数计算出md5的值与上面的校验值$arg_md5进行比较,xm是服务端规定的标识信息
        secure_link_md5 &quot;$secure_link_expiress$uri xm&quot;;

        if($secure_link = &quot;&quot;){
                return 403;
        }
        if($secure_link = &quot;0&quot;){
                return 410;
        }
}</code></pre>
<p>利用shell产生的链接示例：</p>
<pre><code class="shell">servername=&quot;xiao-ming9.github.io&quot;
download_file=&quot;/download/file.img&quot;
time_num=$($date -d &quot;2019-7-23 00:00:00&quot; +%s)
secret_num=&quot;imooc&quot;

res=$(echo -n &quot;${time_num}${download_file} ${secret_num}&quot; |openssl md5 -binary | openssl base64 | tr +/ -_ | tr -d =)

echo &quot;https://${servername}${download_file}?md5=${res}&amp;expires=${time_num}&quot;</code></pre>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2019/07/22/Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90web%E6%9C%8D%E5%8A%A1/" title="Nginx静态资源web服务"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: Nginx静态资源web服务</span></a><a class="button is-default" href="/2019/07/16/SpringBoot/" title="Spring boot"><span class="has-text-weight-semibold">下一页: Spring boot</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xiao-ming9/xiao-ming9.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> silverming 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" href="https://github.com/haojen/hexo-theme-Claudia" target="_blank" rel="noopener" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span>&lt;a href=&quot;http://www.beian.miit.gov.cn/&quot;&gt;备案号&lt;/a&gt;</span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>